<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Socket.IO Demo - TaskFlow</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-5xl mx-auto p-6">
    <h1 class="text-2xl font-bold text-blue-700 mb-4">TaskFlow Socket.IO Demo</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <section class="bg-white rounded shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Autenticación</h2>
        <input id="token" type="hidden"/>
        <div class="flex gap-2">
          <button id="btnConnect" class="bg-blue-600 hover:bg-blue-700 text-white text-sm rounded px-4 py-2">Conectar</button>
          <button id="btnDisconnect" class="bg-gray-500 hover:bg-gray-600 text-white text-sm rounded px-4 py-2">Desconectar</button>
        </div>
        <p id="connStatus" class="text-sm mt-2 text-gray-700">Estado: desconectado</p>
      </section>

      <section class="bg-white rounded shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Acciones Cliente → Servidor</h2>


        <div class="mb-4">
          <button id="btnPing" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm rounded px-4 py-2">ping</button>
        </div>

      </section>
    </div>

    <section class="bg-white rounded shadow p-4 mt-6">
      <h2 class="text-lg font-semibold mb-3">Logs</h2>
      <div id="logs" class="border rounded p-3 bg-gray-50 h-80 overflow-auto text-sm"></div>
    </section>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Auto-llenar token al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('taskflow_token');
      if (token) {
        document.getElementById('token').value = token;
      }
    });
    let socket = null;

    const $ = (id) => document.getElementById(id);
    const logBox = $("logs");
    const connStatus = $("connStatus");

    function log(event, data) {
      const time = new Date().toISOString();
      const el = document.createElement('pre');
      el.textContent = "[" + time + "] " + event + " " + (data !== undefined ? JSON.stringify(data) : "");
      logBox.appendChild(el);
      logBox.scrollTop = logBox.scrollHeight;
      console.log(event, data);
    }

    function setStatus(text, color) {
      connStatus.textContent = "Estado: " + text;
      connStatus.className = "text-sm mt-2 " + (color || "text-gray-700");
    }

    function connectSocket() {
      const token = localStorage.getItem('taskflow_token');
      if (!token) {
        alert("No hay token de autenticación. Inicia sesión primero.");
        return;
      }
      if (socket && socket.connected) {
        log("info", "Ya existe una conexión activa");
        return;
      }

      socket = io("/", {
        extraHeaders: { Authorization: "Bearer " + token },
        // Alternativas también soportadas por el servidor:
        // auth: { token },
        // query: { token },
      });

      socket.on("connect", () => {
        setStatus("conectado (" + socket.id + ")", "text-green-700");
        log("connect", { id: socket.id });
      });

      socket.on("disconnect", (reason) => {
        setStatus("desconectado (" + reason + ")", "text-red-700");
        log("disconnect", { reason });
      });

      // Server → Client events
      socket.on("presence:user:online", (data) => log("presence:user:online", data));
      socket.on("presence:user:offline", (data) => log("presence:user:offline", data));

      socket.on("task:created", (data) => log("task:created", data));
      socket.on("task:updated", (data) => log("task:updated", data));
      socket.on("task:deleted", (data) => log("task:deleted", data));

      socket.on("goal:created", (data) => log("goal:created", data));
      socket.on("goal:updated", (data) => log("goal:updated", data));
      socket.on("goal:deleted", (data) => log("goal:deleted", data));

      socket.on("file:uploaded", (data) => log("file:uploaded", data));
      socket.on("file:deleted", (data) => log("file:deleted", data));

      socket.on("pong", (data) => log("pong", data));
    }

    $("btnConnect").addEventListener("click", connectSocket);

    $("btnDisconnect").addEventListener("click", () => {
      if (socket) {
        socket.disconnect();
      }
    });


    $("btnPing").addEventListener("click", () => {
      if (!socket || !socket.connected) return alert("Conecta primero");
      const ts = Date.now();
      socket.emit("ping", { ts });
      log("emit ping", { ts });
    });

  </script>
</body>
</html>
