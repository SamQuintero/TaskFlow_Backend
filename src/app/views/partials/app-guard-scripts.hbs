<script>
  (function () {
    const TOKEN_KEY = "taskflow_token";

    window.TaskFlowAuth = {
      getToken() {
        try { return localStorage.getItem(TOKEN_KEY); } catch { return null; }
      },
      setToken(token) {
        try {
          if (!token) localStorage.removeItem(TOKEN_KEY);
          else localStorage.setItem(TOKEN_KEY, token);
        } catch {}
      },
      decodeJwt(token) {
        try {
          const p = token.split(".")[1];
          return JSON.parse(atob(p.replace(/-/g, "+").replace(/_/g, "/")));
        } catch { return null; }
      },
      signOut() {
        this.setToken(null);
        window.location.href = "/login";
      }
    };

    // Guard: proteger rutas /app/*
    document.addEventListener("DOMContentLoaded", () => {
      // Capturar token de URL si existe (OAuth callback)
      const urlParams = new URLSearchParams(location.search);
      const tokenFromUrl = urlParams.get('token');
      if (tokenFromUrl) {
        TaskFlowAuth.setToken(tokenFromUrl);
        // Limpiar URL sin recargar
        const cleanUrl = location.pathname;
        history.replaceState(null, '', cleanUrl);
      }

      const onApp = location.pathname.startsWith("/app/");
      const token = TaskFlowAuth.getToken();

      if (onApp && !token) {
        const returnTo = encodeURIComponent(location.pathname);
        window.location.replace(`/login?returnTo=${returnTo}`);
        return;
      }

      // UI de rol (badge de topbar y texto en sidebar si existen)
      const payload = token ? TaskFlowAuth.decodeJwt(token) : null;
      const role = payload?.role;
      const badge = document.getElementById("userRoleBadge");
      const roleEl = document.getElementById("sidebarRole");
      if (badge) {
        if (role) { badge.textContent = role; badge.classList.remove("hidden"); }
        else { badge.classList.add("hidden"); }
      }
      if (roleEl) roleEl.textContent = "Rol: " + (role || "visitante");

      // Logout button
      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) btnLogout.addEventListener("click", () => TaskFlowAuth.signOut());
    });

    // Helper fetch con Authorization
    window.apiFetch = async function (url, options = {}) {
      const token = TaskFlowAuth.getToken();
      const headers = Object.assign(
        { "Content-Type": "application/json" },
        (options.headers || {}),
        token ? { Authorization: "Bearer " + token } : {}
      );
      const res = await fetch(url, Object.assign({}, options, { headers }));
      let body = null;
      try { body = await res.json(); } catch {}
      if (!res.ok) {
        const msg = (body && (body.message || body.error)) || res.statusText || "Error";
        const err = new Error(msg);
        err.status = res.status;
        err.body = body;
        throw err;
      }
      return body;
    };
  })();
</script>
